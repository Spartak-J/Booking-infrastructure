# Upstream definitions
upstream user_api {
    server user-api:8080;
    keepalive 32;
}

upstream offer_api {
    server offer-api:8080;
    keepalive 32;
}

upstream order_api {
    server order-api:8080;
    keepalive 32;
}

# Main server block
server {
    listen 80;
    server_name booking-oselya.pp.ua www.booking-oselya.pp.ua localhost;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Root endpoint
    location / {
        return 200 '{"status":"ok","message":"Booking Oselya API Gateway","version":"1.0"}';
        add_header Content-Type application/json;
    }

    # User API routes
    location /api/auth {
        proxy_pass http://user_api;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    location /api/users {
        proxy_pass http://user_api;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Offer API routes
    location /api/offers {
        proxy_pass http://offer_api;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    location /api/rentobj {
        proxy_pass http://offer_api;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    location /api/bookeddate {
        proxy_pass http://offer_api;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Order API routes
    location /api/orders {
        proxy_pass http://order_api;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Static files (images)
    location /images/ {
        alias /usr/share/nginx/html/images/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # RabbitMQ Management (only for development)
    location /rabbitmq/ {
        proxy_pass http://rabbitmq:15672/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
